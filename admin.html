<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Gabriele Personaliza</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* (Seu CSS anterior continua aqui, adicionei sÃ³ isso para as miniaturas) */
        body { font-family: 'Poppins', sans-serif; background: #F0F2F5; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background: white; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .menu-item { padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #555; }
        .menu-item:hover { background: #B39DDB; color: white; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .table-box { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        .btn-new { background: #B39DDB; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; }
        
        /* NOVO: Estilo das miniaturas no formulÃ¡rio */
        .preview-container { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .preview-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
        
        /* Modal */
        #form-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; }

        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; height: auto; padding: 10px; overflow-x: auto; } .sidebar h2 { display:none; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Gabriele Admin</h2>
        <div class="menu-item"><i class="fas fa-box"></i> Produtos</div>
        <div class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</div>
    </div>

    <div class="main-content">
        <div style="display: flex; justify-content: space-between;">
            <h2>Estoque ðŸ“¦</h2>
            <button class="btn-new" onclick="toggleForm()">+ Novo Produto</button>
        </div>

        <div class="table-box">
            <table>
                <thead>
                    <tr><th>Produto</th><th>PreÃ§o</th><th>AÃ§Ãµes</th></tr>
                </thead>
                <tbody id="lista-produtos"><tr><td>Carregando...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="form-overlay">
        <div class="form-card">
            <h3>Novo Produto</h3>
            
            <label>Fotos (MÃ¡x 3)</label>
            <input type="file" id="novo-fotos" accept="image/*" multiple onchange="processarImagens(this)">
            <div id="preview-area" class="preview-container"></div>
            
            <label>Nome</label><input type="text" id="novo-nome">
            <label>PreÃ§o</label><input type="number" id="novo-preco" step="0.01">
            <label>Categoria</label>
            <select id="novo-categoria">
                <option value="festa">Festa</option>
                <option value="cadernos">Cadernos</option>
                <option value="mimos">Mimos</option>
            </select>

            <button class="btn-new" onclick="adicionarProduto()" style="width:100%">Salvar</button>
            <button onclick="toggleForm()" style="background:none; border:none; width:100%; margin-top:10px; cursor:pointer">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBrRLiEFF8dfWHVxhK3popdYgEDQLiKzCM", authDomain: "gabriele-personaliza.firebaseapp.com", projectId: "gabriele-personaliza", storageBucket: "gabriele-personaliza.firebasestorage.app", messagingSenderId: "403724311605", appId: "1:403724311605:web:850e1bb14459a3ec60e57c", measurementId: "G-T24GYM57CT" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARIÃVEL PARA GUARDAR A LISTA DE FOTOS CONVERTIDAS
        let listaFotosBase64 = [];

        window.processarImagens = (input) => {
            const files = input.files;
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = ''; // Limpa previews antigos
            listaFotosBase64 = []; // Limpa lista antiga

            if (files.length > 3) { alert("Por favor, mÃ¡ximo de 3 fotos!"); input.value = ''; return; }

            // Processa cada arquivo
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // Comprime
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 400; const scale = maxW / img.width;
                        canvas.width = maxW; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const url = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // Adiciona na lista e no preview
                        listaFotosBase64.push(url);
                        previewArea.innerHTML += `<img src="${url}" class="preview-thumb">`;
                    }
                }
                reader.readAsDataURL(file);
            });
        }

        window.adicionarProduto = async () => {
            const nome = document.getElementById('novo-nome').value;
            const preco = document.getElementById('novo-preco').value;
            const cat = document.getElementById('novo-categoria').value;
            
            // Verifica se tem fotos na lista nova OU se usa a lÃ³gica antiga de 1 foto
            const fotosParaSalvar = listaFotosBase64.length > 0 ? listaFotosBase64 : null;

            if(!nome || !preco) return alert("Preencha tudo");
            
            const btn = document.querySelector('.btn-new'); btn.innerText = "...";
            try {
                await addDoc(collection(db, "produtos"), { 
                    nome, 
                    preco: parseFloat(preco), 
                    categoria: cat, 
                    fotos: fotosParaSalvar, // AGORA SALVA A LISTA (ARRAY)
                    ativo: true, 
                    vendas: 0 
                });
                toggleForm(); carregarDados();
                listaFotosBase64 = []; // Reseta
            } catch(e) { alert(e.message); }
            btn.innerText = "Salvar";
        }

        // ... (RESTO DAS FUNÃ‡Ã•ES IGUAIS: toggleForm, logout, carregarDados, apagarProduto ...)
        // Apenas lembre de no carregarDados, se quiser mostrar a foto, pegar a primeira da lista:
        // const imgUrl = (p.fotos && p.fotos.length > 0) ? p.fotos[0] : (p.foto || '');
        
        // PARA POUPARESPAÃ‡O AQUI, USE O MESMO carregarDados DO ANTERIOR, SÃ“ MUDE A LINHA DA FOTO:
        window.carregarDados = async () => {
            const tbody = document.getElementById('lista-produtos');
            try {
                const q = await getDocs(collection(db, "produtos"));
                let html = '';
                q.forEach(doc => {
                    const p = doc.data();
                    // LÃ³gica para pegar a foto (suporta o jeito antigo 'foto' e o novo 'fotos')
                    let thumb = '';
                    if (p.fotos && p.fotos.length > 0) thumb = p.fotos[0];
                    else if (p.foto) thumb = p.foto;
                    
                    const imgTag = thumb ? `<img src="${thumb}" style="width:40px; height:40px; border-radius:5px">` : 'ðŸ“·';

                    html += `<tr>
                        <td><div style="display:flex;gap:10px;align-items:center">${imgTag} ${p.nome}</div></td>
                        <td>R$ ${p.preco}</td>
                        <td><i class="fas fa-trash" onclick="apagarProduto('${doc.id}')" style="color:red;cursor:pointer"></i></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch(e) { console.log(e); }
        }
        
        window.apagarProduto = async (id) => { if(confirm("Apagar?")) { await deleteDoc(doc(db,"produtos",id)); carregarDados(); } }
        window.toggleForm = () => { const el=document.getElementById('form-overlay'); el.style.display=el.style.display==='flex'?'none':'flex'; }
        
        carregarDados();
    </script>
</body>
</html>