<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Gabriele Personaliza</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #F0F2F5; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: white; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .sidebar h2 { color: #B39DDB; margin-bottom: 30px; }
        .menu-item { padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; color: #555; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #B39DDB; color: white; }
        
        /* Conte√∫do Principal */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }

        /* Tabela */
        .table-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; font-size: 0.9rem; }
        th { color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        
        /* Bot√µes e Status */
        .btn-new { background: #B39DDB; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; float: right; font-weight: 600; }
        .btn-status { padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-pendente { background: #FFF3E0; color: #EF6C00; } /* Laranja */
        .status-aguardando { background: #E3F2FD; color: #1976D2; } /* Azul */
        .status-concluido { background: #E8F5E9; color: #2E7D32; } /* Verde */

        /* Modal */
        #form-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; }
        textarea { height: 80px; resize: vertical; }
        
        .mini-foto { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .preview-container { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .preview-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }

        /* √çcones */
        .action-icon { cursor: pointer; margin-left: 10px; font-size: 1.1rem; transition: 0.2s; }
        .icon-edit { color: #2196F3; }
        .icon-trash { color: #ccc; } .icon-trash:hover { color: #F44336; }
        .icon-toggle { color: #4CAF50; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; height: auto; padding: 10px; overflow-x: auto; } .sidebar h2 { display:none; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Gabriele Admin</h2>
        <div class="menu-item active" onclick="mudarAba('produtos')"><i class="fas fa-box"></i> Produtos</div>
        <div class="menu-item" onclick="mudarAba('vendas')"><i class="fas fa-shopping-bag"></i> Vendas</div>
        <div class="menu-item" id="btn-sair"><i class="fas fa-sign-out-alt"></i> Sair</div>
    </div>

    <div class="main-content">
        <div id="view-produtos" class="view-section active">
            <div style="margin-bottom: 20px; overflow: hidden;">
                <h2 style="float: left; margin: 0;">Estoque üì¶</h2>
                <button class="btn-new" onclick="abrirFormulario()">+ Novo Produto</button>
            </div>
            <div class="table-box">
                <table>
                    <thead><tr><th>Produto</th><th>Pre√ßo</th><th>Link</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="lista-produtos"><tr><td colspan="5">Carregando...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="view-vendas" class="view-section">
            <h2 style="margin-bottom: 20px;">Pedidos Realizados üõí</h2>
            <div class="table-box">
                <table>
                    <thead><tr><th>ID</th><th>Data/Hora</th><th>Cliente</th><th>Produto</th><th>Total</th><th>Status</th></tr></thead>
                    <tbody id="lista-vendas"><tr><td colspan="6">Carregando pedidos...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="form-overlay">
        <div class="form-card">
            <h3 id="titulo-modal">Novo Produto</h3>
            
            <label>Fotos (M√°x 3)</label>
            <input type="file" id="novo-fotos" accept="image/*" multiple onchange="processarImagens(this)">
            <div id="preview-area" class="preview-container"></div>

            <label>Nome</label>
            <input type="text" id="novo-nome">
            
            <label>Descri√ß√£o</label>
            <textarea id="novo-desc" placeholder="Detalhes do produto..."></textarea>

            <label>Pre√ßo (R$)</label>
            <input type="number" id="novo-preco" step="0.01">
            
            <label>Link de Pagamento (Mercado Pago/Pix)</label>
            <input type="text" id="novo-link" placeholder="Cole o link aqui (Opcional)">
            
            <label>Categoria</label>
            <select id="novo-categoria">
                <option value="festa">Festa</option>
                <option value="cadernos">Cadernos</option>
                <option value="mimos">Mimos</option>
            </select>

            <button id="btn-salvar" class="btn-new" onclick="salvarProduto()" style="width: 100%;">Salvar</button>
            <button onclick="fecharFormulario()" style="background: none; border: none; width: 100%; margin-top: 10px; cursor: pointer;">Cancelar</button>
        </div>
    </div>

    <script type="module">
        // SEGURAN√áA
        if (sessionStorage.getItem('admin_logado') !== 'sim') {
            if (prompt("üîí Senha Admin:") === 'gabi123') sessionStorage.setItem('admin_logado', 'sim');
            else window.location.href = 'index.html';
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBrRLiEFF8dfWHVxhK3popdYgEDQLiKzCM", authDomain: "gabriele-personaliza.firebaseapp.com", projectId: "gabriele-personaliza", storageBucket: "gabriele-personaliza.firebasestorage.app", messagingSenderId: "403724311605", appId: "1:403724311605:web:850e1bb14459a3ec60e57c", measurementId: "G-T24GYM57CT" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let listaFotosBase64 = [];
        let produtoEmEdicaoId = null;
        let produtosCache = {};

        window.mudarAba = (aba) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${aba}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // CARREGAR PRODUTOS
        async function carregarDados() {
            const tbody = document.getElementById('lista-produtos');
            try {
                const q = await getDocs(collection(db, "produtos"));
                let html = '';
                produtosCache = {};

                q.forEach(docSnap => {
                    const p = docSnap.data();
                    produtosCache[docSnap.id] = p;

                    let thumb = (p.fotos && p.fotos.length > 0) ? p.fotos[0] : (p.foto || '');
                    const img = thumb ? `<img src="${thumb}" class="mini-foto">` : '<div class="mini-foto"></div>';
                    const color = p.ativo ? '#4CAF50' : '#F44336';
                    const linkIcon = p.link_pagamento ? '<i class="fas fa-link" style="color:blue" title="Com Link"></i>' : '<span style="color:#ccc">-</span>';
                    
                    html += `<tr>
                        <td><div style="display:flex; gap:10px; align-items:center;">${img} <strong>${p.nome}</strong></div></td>
                        <td>R$ ${p.preco}</td>
                        <td>${linkIcon}</td>
                        <td><span style="color:${color}; font-weight:bold">${p.ativo ? 'Ativo' : 'Esgotado'}</span></td>
                        <td>
                            <i class="fas fa-pencil-alt action-icon icon-edit" onclick="editarProduto('${docSnap.id}')" title="Editar"></i>
                            <i class="fas fa-trash action-icon icon-trash" onclick="apagarProduto('${docSnap.id}')" title="Excluir"></i>
                            <i class="fas fa-toggle-on action-icon icon-toggle" style="color:${color}" onclick="alterarEstoque('${docSnap.id}', ${!p.ativo})" title="Ativar/Desativar"></i>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        // CARREGAR VENDAS COM DATA E HORA
        async function carregarVendas() {
            const tbody = document.getElementById('lista-vendas');
            try {
                let q; try { q = query(collection(db, "pedidos"), orderBy("data", "desc")); } catch { q = collection(db, "pedidos"); }
                const querySnapshot = await getDocs(q);
                let html = '';
                
                querySnapshot.forEach(doc => {
                    const p = doc.data();
                    
                    // FORMATANDO DATA E HORA
                    const dataObj = p.data ? new Date(p.data) : null;
                    const dataFormatada = dataObj ? dataObj.toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: '2-digit', 
                        hour: '2-digit', minute: '2-digit'
                    }) : '-';

                    // CLASSE DE COR DO STATUS
                    let statusClass = 'status-pendente';
                    if(p.status === 'Conclu√≠do') statusClass = 'status-concluido';
                    if(p.status === 'Aguardando Pagamento') statusClass = 'status-aguardando';

                    const idVisual = p.id_visual || '-';

                    html += `<tr>
                        <td style="font-weight:bold; color:#B39DDB">${idVisual}</td>
                        <td>${dataFormatada}</td>
                        <td>${p.cliente}<br><small>${p.whatsapp}</small></td>
                        <td>${p.produto}</td>
                        <td>R$ ${p.total}</td>
                        <td><span class="btn-status ${statusClass}" style="cursor:pointer" onclick="mudarStatusPedido('${doc.id}', '${p.status}')">${p.status}</span></td>
                    </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="6">Nenhum pedido ainda.</td></tr>';
            } catch(e) { console.error(e); }
        }

        // EDITA, SALVA E CRIA
        window.editarProduto = (id) => {
            const p = produtosCache[id]; if (!p) return;
            produtoEmEdicaoId = id;
            document.getElementById('novo-nome').value = p.nome;
            document.getElementById('novo-desc').value = p.descricao || '';
            document.getElementById('novo-preco').value = p.preco;
            document.getElementById('novo-link').value = p.link_pagamento || '';
            document.getElementById('novo-categoria').value = p.categoria;
            
            const area = document.getElementById('preview-area'); area.innerHTML = '';
            (p.fotos || (p.foto ? [p.foto] : [])).forEach(f => area.innerHTML += `<img src="${f}" class="preview-thumb">`);
            
            document.getElementById('titulo-modal').innerText = "Editar Produto";
            document.getElementById('btn-salvar').innerText = "Atualizar";
            document.getElementById('form-overlay').style.display = 'flex';
        }

        window.salvarProduto = async () => {
            const nome = document.getElementById('novo-nome').value;
            const desc = document.getElementById('novo-desc').value;
            const preco = document.getElementById('novo-preco').value;
            const link = document.getElementById('novo-link').value;
            const cat = document.getElementById('novo-categoria').value;
            
            if(!nome || !preco) return alert("Preencha nome e pre√ßo");
            const btn = document.getElementById('btn-salvar'); btn.innerText = "...";

            try {
                let dados = { nome, descricao: desc, preco: parseFloat(preco), link_pagamento: link, categoria: cat };
                if (listaFotosBase64.length > 0) dados.fotos = listaFotosBase64;
                else if (!produtoEmEdicaoId) dados.fotos = null;

                if (produtoEmEdicaoId) {
                    await updateDoc(doc(db, "produtos", produtoEmEdicaoId), dados);
                    alert("Atualizado!");
                } else {
                    dados.ativo = true; dados.vendas = 0;
                    await addDoc(collection(db, "produtos"), dados);
                    alert("Criado!");
                }
                fecharFormulario(); carregarDados();
            } catch(e) { alert(e.message); }
            btn.innerText = "Salvar";
        }

        window.mudarStatusPedido = async (id, atual) => {
            // Ciclo de status: Pendente -> Conclu√≠do -> Pendente
            // Se estiver 'Aguardando Pagamento', vai para 'Conclu√≠do'
            const novo = (atual === 'Conclu√≠do') ? 'Pendente' : 'Conclu√≠do';
            if(confirm(`Mudar status para ${novo}?`)) { 
                await updateDoc(doc(db, "pedidos", id), { status: novo }); 
                carregarVendas(); 
            }
        }

        window.abrirFormulario = () => {
            produtoEmEdicaoId = null;
            document.getElementById('titulo-modal').innerText = "Novo Produto";
            document.getElementById('btn-salvar').innerText = "Salvar";
            document.querySelectorAll('#form-overlay input, #form-overlay textarea').forEach(i => i.value = '');
            document.getElementById('preview-area').innerHTML = ''; listaFotosBase64 = [];
            document.getElementById('form-overlay').style.display = 'flex';
        }
        window.fecharFormulario = () => document.getElementById('form-overlay').style.display = 'none';

        window.processarImagens = (input) => {
            const files = input.files; const area = document.getElementById('preview-area');
            area.innerHTML = ''; listaFotosBase64 = [];
            if (files.length > 3) return alert("M√°x 3 fotos");
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        const sc = 400 / img.width; cvs.width = 400; cvs.height = img.height * sc;
                        ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                        const url = cvs.toDataURL('image/jpeg', 0.6);
                        listaFotosBase64.push(url);
                        area.innerHTML += `<img src="${url}" class="preview-thumb">`;
                    }
                }
                reader.readAsDataURL(file);
            });
        }

        window.apagarProduto = async (id) => { if(confirm("Apagar?")) { await deleteDoc(doc(db,"produtos",id)); carregarDados(); } }
        window.alterarEstoque = async (id, s) => { await updateDoc(doc(db,"produtos",id), {ativo:s}); carregarDados(); }
        document.getElementById('btn-sair').addEventListener('click', () => { if(confirm("Sair?")){sessionStorage.removeItem('admin_logado'); window.location.href='index.html'} });

        carregarDados(); carregarVendas();
    </script>
</body>
</html>