<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Gabriele Personaliza</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #F0F2F5; margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: white; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .sidebar h2 { color: #B39DDB; margin-bottom: 30px; }
        .menu-item { padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #555; }
        .menu-item:hover, .menu-item.active { background: #B39DDB; color: white; }
        
        /* Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Cards */
        .stats { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .card { background: white; padding: 20px; border-radius: 12px; flex: 1; min-width: 200px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card h3 { font-size: 2rem; margin: 0; color: #333; }
        .card p { margin: 0; color: #777; font-size: 0.9rem; }

        /* Tabela */
        .table-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; color: #777; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .btn-new { background: #B39DDB; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; float: right; }
        .btn-new:hover { background: #9575CD; }

        .mini-foto { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; }

        /* Modal */
        #form-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; position: relative; max-height: 90vh; overflow-y: auto; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; }
        
        /* NOVO: Estilo para previews m√∫ltiplos */
        .preview-container { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .preview-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }

        /* Responsivo */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            .sidebar { width: 100%; flex-direction: row; padding: 10px; overflow-x: auto; height: auto; }
            .sidebar h2 { display: none; }
            .menu-item { white-space: nowrap; margin-right: 10px; font-size: 0.8rem; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Gabriele Admin</h2>
        <div class="menu-item active"><i class="fas fa-box"></i> Produtos</div>
        <div class="menu-item" id="btn-sair"><i class="fas fa-sign-out-alt"></i> Sair</div>
    </div>

    <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Ol√°! üëã</h2>
        </div>

        <div class="stats">
            <div class="card">
                <h3 id="total-vendas">0</h3>
                <p>Vendas</p>
            </div>
            <div class="card">
                <h3 id="total-produtos">0</h3>
                <p>Produtos</p>
            </div>
            <div class="card">
                <h3 id="total-esgotados" style="color: #ff7675;">0</h3>
                <p>Esgotados</p>
            </div>
        </div>

        <div class="table-box">
            <div style="margin-bottom: 20px; overflow: hidden;">
                <h3 style="float: left; margin: 0;">Estoque</h3>
                <button class="btn-new" onclick="toggleForm()">+ Novo</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Pre√ßo</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-produtos">
                    <tr><td colspan="4" style="text-align: center;">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="form-overlay">
        <div class="form-card">
            <h3 style="margin-top:0">Novo Produto</h3>
            
            <label>Fotos (M√°x 3)</label>
            <input type="file" id="novo-fotos" accept="image/*" multiple onchange="processarImagens(this)">
            <div id="preview-area" class="preview-container"></div>

            <label>Nome</label>
            <input type="text" id="novo-nome">
            
            <label>Pre√ßo</label>
            <input type="number" id="novo-preco" step="0.01">
            
            <label>Categoria</label>
            <select id="novo-categoria">
                <option value="festa">Festa</option>
                <option value="cadernos">Cadernos</option>
                <option value="mimos">Mimos</option>
            </select>

            <button class="btn-new" onclick="adicionarProduto()" style="float: none; width: 100%;">Salvar</button>
            <button onclick="toggleForm()" style="background: none; border: none; width: 100%; margin-top: 10px; cursor: pointer;">Cancelar</button>
        </div>
    </div>

    <script type="module">
        // 1. SEGURAN√áA
        if (sessionStorage.getItem('admin_logado') !== 'sim') {
            const senha = prompt("üîí Digite a senha de Admin:");
            if (senha === 'gabi123') {
                sessionStorage.setItem('admin_logado', 'sim');
            } else {
                alert("Senha errada.");
                window.location.href = 'index.html';
            }
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrRLiEFF8dfWHVxhK3popdYgEDQLiKzCM",
            authDomain: "gabriele-personaliza.firebaseapp.com",
            projectId: "gabriele-personaliza",
            storageBucket: "gabriele-personaliza.firebasestorage.app",
            messagingSenderId: "403724311605",
            appId: "1:403724311605:web:850e1bb14459a3ec60e57c",
            measurementId: "G-T24GYM57CT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let listaFotosBase64 = [];

        // FUN√á√ïES GLOBAIS
        window.toggleForm = () => {
            const el = document.getElementById('form-overlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        // --- CORRE√á√ÉO DO BOT√ÉO SAIR ---
        document.getElementById('btn-sair').addEventListener('click', () => {
            if(confirm("Deseja sair do painel?")) {
                sessionStorage.removeItem('admin_logado');
                window.location.replace('index.html');
            }
        });

        window.processarImagens = (input) => {
            const files = input.files;
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = ''; 
            listaFotosBase64 = []; 

            if (files.length > 3) { alert("M√°ximo de 3 fotos!"); input.value = ''; return; }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 400; const scale = maxW / img.width;
                        canvas.width = maxW; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const url = canvas.toDataURL('image/jpeg', 0.6);
                        
                        listaFotosBase64.push(url);
                        previewArea.innerHTML += `<img src="${url}" class="preview-thumb">`;
                    }
                }
                reader.readAsDataURL(file);
            });
        }

        async function carregarDados() {
            const tbody = document.getElementById('lista-produtos');
            try {
                const querySnapshot = await getDocs(collection(db, "produtos"));
                let html = '';
                let tVendas = 0, tProd = 0, tEsg = 0;

                querySnapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    const id = docSnap.id;
                    tVendas += (p.vendas || 0);
                    if(p.ativo) tProd++; else tEsg++;

                    let thumb = '';
                    if (p.fotos && p.fotos.length > 0) thumb = p.fotos[0];
                    else if (p.foto) thumb = p.foto;
                    const img = thumb ? `<img src="${thumb}" class="mini-foto">` : '<div class="mini-foto"></div>';

                    const color = p.ativo ? '#4CAF50' : '#F44336';
                    const icon = p.ativo ? 'fa-toggle-on' : 'fa-toggle-off';

                    html += `
                        <tr>
                            <td><div style="display:flex; gap:10px; align-items:center;">${img} <strong>${p.nome}</strong></div></td>
                            <td>R$ ${p.preco}</td>
                            <td><span style="color:${color}; font-weight:bold">${p.ativo ? 'Ativo' : 'Esgotado'}</span></td>
                            <td>
                                <i class="fas ${icon}" style="color:${color}; cursor:pointer; margin-right:10px;" onclick="alterarEstoque('${id}', ${!p.ativo})"></i>
                                <i class="fas fa-trash" style="color:#ccc; cursor:pointer;" onclick="apagarProduto('${id}')"></i>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center">Nada encontrado.</td></tr>';
                document.getElementById('total-vendas').innerText = tVendas;
                document.getElementById('total-produtos').innerText = tProd;
                document.getElementById('total-esgotados').innerText = tEsg;
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center">${error.message}</td></tr>`;
            }
        }

        window.alterarEstoque = async (id, s) => { await updateDoc(doc(db,"produtos",id), {ativo:s}); carregarDados(); }
        window.apagarProduto = async (id) => { if(confirm("Apagar?")) { await deleteDoc(doc(db,"produtos",id)); carregarDados(); } }
        
        window.adicionarProduto = async () => {
            const nome = document.getElementById('novo-nome').value;
            const preco = document.getElementById('novo-preco').value;
            const cat = document.getElementById('novo-categoria').value;
            const fotosParaSalvar = listaFotosBase64.length > 0 ? listaFotosBase64 : null;

            if(!nome || !preco) return alert("Preencha tudo");
            
            const btn = document.querySelector('.btn-new');
            btn.innerText = "...";
            try {
                await addDoc(collection(db, "produtos"), { 
                    nome, preco: parseFloat(preco), categoria: cat, fotos: fotosParaSalvar, ativo: true, vendas: 0 
                });
                toggleForm(); carregarDados();
                document.getElementById('novo-nome').value = '';
                listaFotosBase64 = [];
                document.getElementById('preview-area').innerHTML = '';
            } catch(e) { alert(e.message); }
            btn.innerText = "Salvar";
        }

        carregarDados();
    </script>
</body>
</html>