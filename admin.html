<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Prime | Gabriele</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS GERAL */
        body { font-family: 'Poppins', sans-serif; background: #F0F2F5; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .btn-entrar { background: #B39DDB; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-entrar:hover { background: #9575CD; }
        .error-msg { color: red; font-size: 0.8rem; margin-top: 15px; display: none; background: #FFEBEE; padding: 10px; border-radius: 5px; border: 1px solid #FFCDD2; }

        /* LAYOUT */
        #painel-app { display: none; width: 100%; height: 100%; }
        .sidebar { width: 250px; background: white; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .sidebar h2 { color: #B39DDB; margin-bottom: 30px; }
        .menu-item { padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; color: #555; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #B39DDB; color: white; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #F0F2F5; }
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }

        /* TABELA */
        .table-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; font-size: 0.9rem; }
        th { color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; background: #f9f9f9; }
        .btn-new { background: #B39DDB; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; float: right; font-weight: 600; }
        .btn-status { padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-pendente { background: #FFF3E0; color: #EF6C00; } 
        .status-aguardando { background: #E3F2FD; color: #1976D2; } 
        .status-concluido { background: #E8F5E9; color: #2E7D32; } 
        .action-icon { cursor: pointer; margin-left: 10px; font-size: 1.2rem; transition: 0.2s; padding: 5px; }
        .icon-edit { color: #2196F3; } .icon-trash { color: #ccc; } .icon-trash:hover { color: #F44336; } .icon-toggle { color: #4CAF50; }
        .mini-foto { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; border: 1px solid #ddd; }

        /* MODAL FORM */
        #form-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .form-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; }
        textarea { height: 80px; resize: vertical; }
        .promo-box { background: #FCE4EC; padding: 15px; border-radius: 8px; border: 1px solid #F8BBD0; margin: 15px 0; }
        
        /* PREVIEW FOTOS */
        .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .thumb-wrapper { position: relative; width: 70px; height: 70px; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .btn-remove-foto { position: absolute; top: -8px; right: -8px; background: #F44336; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid white; }
        .btn-remove-foto:hover { transform: scale(1.1); }

        /* TOAST E LOADING */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; min-width: 250px; border-left: 5px solid #ccc; font-weight: 500; }
        .toast-success { border-left-color: #4CAF50; } .toast-success i { color: #4CAF50; }
        .toast-error { border-left-color: #F44336; } .toast-error i { color: #F44336; }
        .toast-info { border-left-color: #2196F3; } .toast-info i { color: #2196F3; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 20000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #B39DDB; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .loading-text { font-size: 1.1rem; color: #555; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL DE CONFIRMA√á√ÉO PREMIUM */
        #confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 30000; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .confirm-box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .confirm-box h3 { margin: 0 0 10px 0; color: #333; }
        .confirm-box p { color: #666; font-size: 0.95rem; margin-bottom: 20px; }
        .confirm-btns { display: flex; gap: 10px; }
        .btn-cancel { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #eee; color: #555; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-cancel:hover { background: #e0e0e0; }
        .btn-action { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }

        /* MOBILE */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            #painel-app { flex-direction: column; height: auto; }
            .sidebar { width: 100%; flex-direction: row; height: auto; padding: 15px; overflow-x: auto; position: sticky; top:0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            .sidebar h2 { display:none; }
            .menu-item { margin-bottom: 0; margin-right: 10px; white-space: nowrap; font-size: 0.9rem; padding: 10px 15px; }
            .main-content { padding: 15px; height: auto; }
            .table-box { padding: 0; background: transparent; box-shadow: none; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 15px; border: 1px solid #eee; }
            td { border: none; position: relative; padding: 10px 0 10px 45%; text-align: right; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: flex-end; align-items: center; min-height: 30px; }
            td:last-child { border-bottom: none; }
            td::before { content: attr(data-label); position: absolute; left: 0; width: 40%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: 600; color: #888; font-size: 0.85rem; }
            td:first-child { padding-left: 0; display: block; text-align: left; }
            td:first-child::before { display: none; }
            .mini-foto { width: 60px; height: 60px; }
            .btn-new { float: none; width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-msg">Processando...</div>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <i id="confirm-icon" class="fas fa-question-circle" style="font-size: 3rem; color: #B39DDB; margin-bottom: 15px;"></i>
            <h3 id="confirm-title">Aten√ß√£o</h3>
            <p id="confirm-msg">Deseja continuar?</p>
            <div class="confirm-btns">
                <button class="btn-cancel" onclick="fecharConfirm()">Cancelar</button>
                <button id="btn-confirm-yes" class="btn-action">Sim</button>
            </div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <i class="fas fa-user-shield" style="font-size: 3rem; color: #B39DDB; margin-bottom: 10px;"></i>
            <h3>Acesso Restrito</h3>
            <p style="color:#666; font-size:0.8rem; margin-bottom:20px;">Entre com suas credenciais</p>
            <input type="email" id="email-admin" class="login-input" value="gabyguedes534@gmail.com" readonly style="background:#f0f0f0; color:#555">
            <input type="password" id="senha-admin" class="login-input" placeholder="Senha">
            <button class="btn-entrar" onclick="login()">Acessar Painel</button>
            <p id="login-erro" class="error-msg">Dados incorretos!</p>
        </div>
    </div>

    <div id="painel-app">
        <div class="sidebar">
            <h2>Admin Prime</h2>
            <div class="menu-item active" onclick="mudarAba('produtos')"><i class="fas fa-box"></i> Produtos</div>
            <div class="menu-item" onclick="mudarAba('vendas')"><i class="fas fa-shopping-bag"></i> Vendas</div>
            <div class="menu-item" id="btn-sair"><i class="fas fa-sign-out-alt"></i> Sair</div>
        </div>

        <div class="main-content">
            <div id="view-produtos" class="view-section active">
                <div style="margin-bottom: 20px;">
                    <h2 style="margin: 0 0 10px 0;">Estoque üì¶</h2>
                    <button class="btn-new" onclick="abrirFormulario()">+ Novo Produto</button>
                </div>
                <div class="table-box">
                    <table>
                        <thead><tr><th>Produto</th><th>Pre√ßo</th><th>M√≠nimo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="lista-produtos"><tr><td colspan="5">Carregando...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="view-vendas" class="view-section">
                <h2 style="margin-bottom: 20px;">Pedidos Realizados üõí</h2>
                <div class="table-box">
                    <table>
                        <thead><tr><th>ID / Detalhes</th><th>Data</th><th>Cliente</th><th>Total</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="lista-vendas"><tr><td colspan="6">Carregando pedidos...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="form-overlay">
        <div class="form-card">
            <h3 id="titulo-modal">Novo Produto</h3>
            <label>Fotos (M√°x 3) - ALTA QUALIDADE üì∏</label>
            <div style="margin-bottom: 15px;">
                <label for="novo-fotos" style="background:#B39DDB; color:white; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:0.9rem; display:inline-block;"><i class="fas fa-camera"></i> Adicionar Foto</label>
                <input type="file" id="novo-fotos" accept="image/*" multiple style="display:none" onchange="adicionarFotos(this)">
            </div>
            <div id="preview-area" class="preview-container"></div>
            
            <label>Nome</label><input type="text" id="novo-nome">
            <label>Descri√ß√£o</label><textarea id="novo-desc" placeholder="Detalhes..."></textarea>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><label>Pre√ßo (R$)</label><input type="number" id="novo-preco" step="0.01"></div>
                <div><label>Qtd. M√≠nima</label><input type="number" id="novo-minimo" value="1" min="1"></div>
            </div>

            <div class="promo-box">
                <label style="display:flex; align-items:center; gap:10px; font-weight:bold; color:#E91E63; cursor:pointer">
                    <input type="checkbox" id="cb-promocao" onchange="togglePromoField()"> Produto em Promo√ß√£o?
                </label>
                <div id="promo-field-container" style="display:none; margin-top:10px;">
                    <label>Pre√ßo Promocional (R$)</label>
                    <input type="number" id="novo-preco-promo" step="0.01">
                </div>
            </div>

            <label>Link de Pagamento (Opcional)</label><input type="text" id="novo-link" placeholder="Mercado Pago/Pix">
            
            <label>Categoria</label>
            <select id="novo-categoria">
                <option value="festa">Festa</option>
                <option value="comemorativas">Datas Comemorativas</option>
                <option value="cadernos">Cadernos</option>
                <option value="mimos">Mimos</option>
                <option value="simples">Simples</option>
                <option value="semiluxo">Semi Luxo</option>
            </select>

            <div id="div-evento" style="display:none; margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; border-left:4px solid #B39DDB;">
                <label style="color:#B39DDB; font-weight:bold;">Qual Data Comemorativa?</label>
                <select id="novo-evento" style="margin-top:5px;">
                    <option value="mulher">Dia da Mulher (Mar√ßo)</option>
                    <option value="pascoa">P√°scoa (Abril)</option>
                    <option value="maes">Dia das M√£es (Maio)</option>
                    <option value="namorados">Dia dos Namorados (Junho)</option>
                    <option value="pais">Dia dos Pais (Agosto)</option>
                    <option value="criancas">Dia das Crian√ßas (Outubro)</option>
                    <option value="professores">Dia dos Professores (Outubro)</option>
                    <option value="natal">Natal (Dezembro)</option>
                    <option value="ano_novo">Ano Novo (Jan)</option>
                </select>
            </div>
            
            <button id="btn-salvar" class="btn-new" onclick="salvarProduto()" style="width: 100%; margin-top:20px;">Salvar</button>
            <button onclick="fecharFormulario()" style="background: none; border: none; width: 100%; margin-top: 10px; cursor: pointer; color:#666;">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBrRLiEFF8dfWHVxhK3popdYgEDQLiKzCM", authDomain: "gabriele-personaliza.firebaseapp.com", projectId: "gabriele-personaliza", storageBucket: "gabriele-personaliza.firebasestorage.app", messagingSenderId: "403724311605", appId: "1:403724311605:web:850e1bb14459a3ec60e57c", measurementId: "G-T24GYM57CT" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const IMGBB_API_KEY = "466fe160d29a71d0e6a2d6194d53173a"; 
        
        let listaFotosEdicao = []; 
        let produtoEmEdicaoId = null;
        let produtosCache = {};

        // SISTEMA DE CONFIRMA√á√ÉO PREMIUM
        window.showConfirm = (msg, callback, tipo = 'danger') => {
            document.getElementById('confirm-msg').innerText = msg;
            const btn = document.getElementById('btn-confirm-yes');
            const icone = document.getElementById('confirm-icon');
            
            if(tipo === 'danger') {
                btn.style.background = '#F44336'; btn.innerText = 'Sim, excluir';
                icone.className = 'fas fa-exclamation-triangle'; icone.style.color = '#F44336';
            } else {
                btn.style.background = '#B39DDB'; btn.innerText = 'Sim, continuar';
                icone.className = 'fas fa-question-circle'; icone.style.color = '#B39DDB';
            }
            btn.onclick = () => { fecharConfirm(); callback(); };
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        window.fecharConfirm = () => document.getElementById('confirm-modal').style.display = 'none';

        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
            if(type === 'info') icon = 'info-circle';
            toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        window.showLoading = (msg) => {
            document.getElementById('loading-msg').innerText = msg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        window.hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                document.getElementById('login-screen').style.display = 'none'; 
                document.getElementById('painel-app').style.display = 'flex'; 
                carregarDados(); carregarVendas(); 
            } else { 
                document.getElementById('login-screen').style.display = 'flex'; 
                document.getElementById('painel-app').style.display = 'none'; 
            }
        });

        window.login = async () => {
            const email = document.getElementById('email-admin').value; const senha = document.getElementById('senha-admin').value;
            const btn = document.querySelector('.btn-entrar'); const erro = document.getElementById('login-erro');
            btn.innerText = "Verificando..."; erro.style.display = 'none';
            try { await signInWithEmailAndPassword(auth, email, senha); showToast("Acesso Liberado!", "success"); } 
            catch (error) { erro.innerText = "Senha incorreta."; erro.style.display = 'block'; btn.innerText = "Acessar Painel"; showToast("Senha Incorreta", "error"); }
        }
        
        document.getElementById('btn-sair').addEventListener('click', () => { 
            showConfirm("Deseja realmente sair do painel?", () => { signOut(auth); window.location.href = 'index.html'; }, 'info');
        });

        const formatarMoeda = (v) => parseFloat(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        window.togglePromoField = () => { document.getElementById('promo-field-container').style.display = document.getElementById('cb-promocao').checked ? 'block' : 'none'; }
        window.mudarAba = (aba) => { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active')); document.getElementById(`view-${aba}`).classList.add('active'); event.currentTarget.classList.add('active'); }

        // MOSTRAR/ESCONDER DATA COMEMORATIVA
        document.getElementById('novo-categoria').addEventListener('change', (e) => {
            document.getElementById('div-evento').style.display = e.target.value === 'comemorativas' ? 'block' : 'none';
        });

        const nomeEventos = { 'mulher':'Dia da Mulher', 'pascoa':'P√°scoa', 'maes':'Dia das M√£es', 'namorados':'Dia dos Namorados', 'pais':'Dia dos Pais', 'criancas':'Dia das Crian√ßas', 'professores':'Dia dos Professores', 'natal':'Natal', 'ano_novo':'Ano Novo' };

        async function carregarDados() {
            const tbody = document.getElementById('lista-produtos');
            try {
                const q = await getDocs(collection(db, "produtos"));
                let html = ''; produtosCache = {};
                q.forEach(docSnap => {
                    const p = docSnap.data();
                    produtosCache[docSnap.id] = p;
                    let thumb = (p.fotos && p.fotos.length > 0) ? p.fotos[0] : (p.foto || '');
                    
                    const timestamp = new Date().getTime();
                    let finalThumb = thumb;
                    if(thumb.startsWith('http')) finalThumb = `${thumb}?t=${timestamp}`;

                    const img = thumb ? `<img src="${finalThumb}" class="mini-foto">` : '<div class="mini-foto"></div>';
                    const color = p.ativo ? '#4CAF50' : '#F44336';
                    const minDisplay = p.minimo > 1 ? `${p.minimo} un` : '1 un';
                    let priceDisplay = formatarMoeda(p.preco);
                    if(p.em_promocao && p.preco_promocional > 0) priceDisplay = `<div><span style="text-decoration:line-through;color:#999;font-size:0.8em">${formatarMoeda(p.preco)}</span> <strong style="color:#E91E63">${formatarMoeda(p.preco_promocional)}</strong></div>`;
                    
                    let nomeCatDisplay = p.categoria === 'comemorativas' && p.evento ? `Especial: ${nomeEventos[p.evento]}` : p.categoria;

                    html += `<tr>
                        <td data-label="Produto"><div style="display:flex; gap:15px; align-items:center;">${img} <div style="text-align:left"><strong>${p.nome}</strong><br><small style="color:#777">${nomeCatDisplay}</small></div></div></td>
                        <td data-label="Pre√ßo">${priceDisplay}</td>
                        <td data-label="M√≠nimo">${minDisplay}</td>
                        <td data-label="Status"><span style="color:${color}; font-weight:bold">${p.ativo ? 'Ativo' : 'Esgotado'}</span></td>
                        <td data-label="A√ß√µes">
                            <i class="fas fa-pencil-alt action-icon icon-edit" onclick="editarProduto('${docSnap.id}')"></i>
                            <i class="fas fa-trash action-icon icon-trash" onclick="apagarProduto('${docSnap.id}')"></i>
                            <i class="fas fa-toggle-on action-icon icon-toggle" style="color:${color}" onclick="alterarEstoque('${docSnap.id}', ${!p.ativo})"></i>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function carregarVendas() {
            const tbody = document.getElementById('lista-vendas');
            try {
                let q; try { q = query(collection(db, "pedidos"), orderBy("data", "desc")); } catch { q = collection(db, "pedidos"); }
                const qs = await getDocs(q); let html = '';
                qs.forEach(doc => {
                    const p = doc.data();
                    const dataF = p.data ? new Date(p.data).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
                    let statusClass = p.status==='Conclu√≠do'?'status-concluido':(p.status==='Aguardando Pagamento'?'status-aguardando':'status-pendente');
                    html += `<tr>
                        <td data-label="ID / Produto"><div style="text-align:left"><strong style="color:#B39DDB">${p.id_visual||'-'}</strong><br>${p.produto}</div></td>
                        <td data-label="Data">${dataF}</td>
                        <td data-label="Cliente"><div style="text-align:left">${p.cliente}<br><small><a href="https://wa.me/55${p.whatsapp.replace(/\D/g,'')}" target="_blank" style="color:#25D366;text-decoration:none"><i class="fab fa-whatsapp"></i> ${p.whatsapp}</a></small></div></td>
                        <td data-label="Total"><strong>${formatarMoeda(p.total)}</strong></td>
                        <td data-label="Status"><span class="btn-status ${statusClass}" onclick="mudarStatusPedido('${doc.id}','${p.status}')" style="cursor:pointer">${p.status}</span></td>
                        <td data-label="A√ß√µes"><i class="fas fa-trash action-icon icon-trash" onclick="apagarPedido('${doc.id}')"></i></td>
                    </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum pedido encontrado.</td></tr>';
            } catch(e) { console.error(e); }
        }

        window.adicionarFotos = (input) => {
            const files = Array.from(input.files);
            if((listaFotosEdicao.length + files.length) > 3) { showToast("M√°ximo de 3 fotos!", "error"); return; }
            listaFotosEdicao = [...listaFotosEdicao, ...files];
            renderizarPreview(); input.value = ''; 
        }

        window.removerFoto = (index) => { listaFotosEdicao.splice(index, 1); renderizarPreview(); }

        function renderizarPreview() {
            const area = document.getElementById('preview-area'); area.innerHTML = '';
            listaFotosEdicao.forEach((item, index) => {
                let src = ''; if(typeof item === 'string') src = item; else src = URL.createObjectURL(item);
                area.innerHTML += `<div class="thumb-wrapper"><img src="${src}" class="thumb-img"><div class="btn-remove-foto" onclick="removerFoto(${index})">X</div></div>`;
            });
        }

        const comprimirImagem = async (arquivo) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(arquivo);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const MAX_WIDTH = 1920; 
                        let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], arquivo.name, { type: 'image/jpeg', lastModified: Date.now() }));
                        }, 'image/jpeg', 0.8); 
                    };
                };
            });
        };

        window.salvarProduto = async () => {
            const nome = document.getElementById('novo-nome').value; const desc = document.getElementById('novo-desc').value;
            const preco = document.getElementById('novo-preco').value; const minimo = document.getElementById('novo-minimo').value;
            const link = document.getElementById('novo-link').value; const cat = document.getElementById('novo-categoria').value;
            const evento = cat === 'comemorativas' ? document.getElementById('novo-evento').value : null;
            const emPromocao = document.getElementById('cb-promocao').checked; const precoPromo = document.getElementById('novo-preco-promo').value;
            
            if(!nome || !preco) { showToast("Preencha o nome e o pre√ßo!", "error"); return; }

            try {
                showLoading("Iniciando...");
                let listaFinaisUrls = []; let contadorNovas = 0; let arquivosParaEnviar = listaFotosEdicao.filter(item => typeof item !== 'string');
                
                for (let i = 0; i < listaFotosEdicao.length; i++) {
                    const item = listaFotosEdicao[i];
                    if (typeof item === 'string') { listaFinaisUrls.push(item); } else {
                        contadorNovas++; showLoading(`Otimizando foto ${contadorNovas}/${arquivosParaEnviar.length}...`);
                        const arquivoLeve = await comprimirImagem(item);
                        const formData = new FormData(); formData.append("image", arquivoLeve);
                        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                        if (!response.ok) throw new Error("Falha ao subir foto");
                        const result = await response.json();
                        if(result.success) { listaFinaisUrls.push(result.data.url); } else { throw new Error(result.error.message); }
                    }
                }

                let dados = {
                    nome, descricao: desc, preco: parseFloat(preco), minimo: parseInt(minimo)||1, link_pagamento: link, categoria: cat, evento: evento,
                    emPromocao: emPromocao, preco_promocional: emPromocao ? parseFloat(precoPromo) : null, fotos: listaFinaisUrls
                };

                showLoading("Salvando...");
                if(produtoEmEdicaoId){
                    await updateDoc(doc(db,"produtos",produtoEmEdicaoId), dados);
                    showToast("Produto atualizado com sucesso!", "success");
                } else {
                    dados.ativo = true; dados.vendas = 0;
                    await addDoc(collection(db,"produtos"), dados);
                    showToast("Produto criado com sucesso!", "success");
                }
                fecharFormulario(); carregarDados();
            } catch(e) { console.error(e); showToast("Erro: " + e.message, "error"); } finally { hideLoading(); }
        }

        window.editarProduto=(id)=>{
            const p=produtosCache[id]; if(!p)return;
            produtoEmEdicaoId=id;
            document.getElementById('novo-nome').value=p.nome;
            document.getElementById('novo-desc').value=p.descricao||'';
            document.getElementById('novo-preco').value=p.preco;
            document.getElementById('novo-minimo').value=p.minimo||1;
            document.getElementById('novo-link').value=p.link_pagamento||'';
            
            document.getElementById('novo-categoria').value=p.categoria;
            document.getElementById('div-evento').style.display = p.categoria === 'comemorativas' ? 'block' : 'none';
            if(p.evento) document.getElementById('novo-evento').value = p.evento;

            document.getElementById('cb-promocao').checked=p.em_promocao||false;
            document.getElementById('novo-preco-promo').value=p.preco_promocional||'';
            togglePromoField();
            listaFotosEdicao = [];
            if(p.fotos && p.fotos.length > 0) listaFotosEdicao = [...p.fotos]; else if (p.foto) listaFotosEdicao = [p.foto];
            renderizarPreview();
            document.getElementById('titulo-modal').innerText="Editar Produto";
            document.getElementById('form-overlay').style.display='flex';
        }

        window.abrirFormulario=()=>{
            produtoEmEdicaoId=null;
            document.getElementById('titulo-modal').innerText="Novo Produto";
            document.querySelectorAll('#form-overlay input, #form-overlay textarea').forEach(i=>i.value='');
            document.getElementById('novo-minimo').value='1';
            document.getElementById('cb-promocao').checked=false;
            document.getElementById('div-evento').style.display='none';
            togglePromoField(); listaFotosEdicao = []; renderizarPreview();
            document.getElementById('form-overlay').style.display='flex';
        }
        window.fecharFormulario=()=>document.getElementById('form-overlay').style.display='none';
        
        window.mudarStatusPedido=async(id,s)=>{
            const n=s==='Conclu√≠do'?'Pendente':'Conclu√≠do';
            showConfirm(`Deseja alterar o status para ${n}?`, async () => {
                try { await updateDoc(doc(db,"pedidos",id),{status:n}); showToast("Status atualizado!", "info"); carregarVendas(); } 
                catch(e) { showToast("Erro ao atualizar", "error"); }
            }, 'info');
        }
        
        window.apagarPedido=async(id)=>{
            showConfirm("Tem certeza que deseja APAGAR este pedido?", async () => {
                try { await deleteDoc(doc(db,"pedidos",id)); showToast("Pedido removido!", "success"); carregarVendas(); } 
                catch(e) { showToast("Erro ao apagar", "error"); }
            });
        }
        
        window.apagarProduto=async(id)=>{
            showConfirm("Tem certeza que deseja EXCLUIR este produto? A√ß√£o irrevers√≠vel.", async () => {
                try { await deleteDoc(doc(db,"produtos",id)); showToast("Produto removido!", "success"); carregarDados(); } 
                catch(e) { showToast("Erro ao apagar", "error"); }
            });
        }
        
        window.alterarEstoque=async(id,s)=>{
            try { await updateDoc(doc(db,"produtos",id),{ativo:s}); showToast(s ? "Produto ativado!" : "Produto pausado", "info"); carregarDados(); } 
            catch(e) { showToast("Erro ao alterar estoque", "error"); }
        }
    </script>
</body>
</html>