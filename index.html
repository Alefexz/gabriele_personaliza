<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja | Gabriele Personaliza</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* CSS do Modal e Alertas */
        .modal-produto-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: end; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; position: relative; max-height: 90vh; overflow-y: auto; }
        @media(min-width: 768px) { .modal-produto-overlay { align-items: center; } .modal-content { border-radius: 20px; } }
        @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }
        
        .modal-img-container { height: 250px; overflow: hidden; border-radius: 10px; margin-bottom: 15px; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; }
        .modal-img { width: 100%; height: 100%; object-fit: cover; flex-shrink: 0; scroll-snap-align: center; }
        
        .modal-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: #333; margin-bottom: 5px; }
        .modal-price { font-size: 1.3rem; color: #B39DDB; font-weight: bold; margin-bottom: 15px; }
        .modal-desc { font-size: 0.9rem; color: #666; line-height: 1.6; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #555; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        
        .btn-comprar { background: #25D366; color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; gap: 10px; align-items: center; margin-top: 10px; }
        .btn-cartao { background: #009EE3; color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; display: none; justify-content: center; gap: 10px; align-items: center; margin-bottom: 10px; }
        
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

        /* Modal de Sucesso */
        #modal-sucesso { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; text-align: center; }
        .sucesso-card { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; }
        .pedido-id { font-size: 1.5rem; font-weight: bold; color: #B39DDB; margin: 10px 0; letter-spacing: 2px; border: 2px dashed #B39DDB; padding: 10px; border-radius: 10px; display: inline-block; }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <a href="#" class="logo">Gabriele <span>Personaliza</span></a>
            <nav>
                <div class="menu-toggle"><i class="fas fa-bars"></i></div>
                <ul class="nav-links">
                    <li><a href="#loja" class="active">Loja</a></li>
                    <li><a href="#sobre">Sobre</a></li>
                    <li><a href="https://wa.me/559292770409" class="btn-nav">Falar no WhatsApp</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="welcome-banner">
        <div class="container">
            <h1>Seja bem-vindo(a)!</h1>
            <p>Transforme sua festa com nossa papelaria criativa.</p>
            <div class="arrow-down"><i class="fas fa-chevron-down"></i></div>
        </div>
    </section>

    <section id="loja" class="section-padding store-section">
        <div class="container">
            <div class="filter-container">
                <button class="filter-btn active" onclick="carregarLoja('todos')">Todos</button>
                <button class="filter-btn" onclick="carregarLoja('festa')">Festas</button>
                <button class="filter-btn" onclick="carregarLoja('cadernos')">Cadernos</button>
                <button class="filter-btn" onclick="carregarLoja('mimos')">Mimos</button>
            </div>
            <div class="product-grid" id="container-produtos">
                <p style="text-align:center; width:100%;">Carregando...</p>
            </div>
        </div>
    </section>

    <section id="sobre" class="section-padding" style="background:#fff;">
        <div class="container about-container">
            <div class="about-text">
                <h2 class="section-title" style="text-align:left;">Quem faz?</h2>
                <p>A <strong>Gabriele Personaliza</strong> transforma papel em memórias eternas com cortes precisos e montagem à mão.</p>
            </div>
        </div>
    </section>

    <footer id="contato">
        <div class="container">
            <div class="footer-brand"><h3>Gabriele Personaliza</h3><p>Feito com amor.</p></div>
            <div class="socials">
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-whatsapp"></i></a>
            </div>
            <div class="copyright">
                <p>&copy; 2026. <span id="btn-secreto" style="opacity:0.2;cursor:pointer">G</span></p>
            </div>
        </div>
    </footer>

    <div id="modal-produto" class="modal-produto-overlay">
        <div class="modal-content">
            <i class="fas fa-times close-modal" onclick="fecharModal()"></i>
            
            <div id="modal-imagens" class="modal-img-container"></div>
            
            <h3 id="modal-titulo" class="modal-title">Nome do Produto</h3>
            <div id="modal-preco" class="modal-price">R$ 0,00</div>
            <div id="modal-descricao" class="modal-desc"></div>
            
            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                <div class="input-group">
                    <label>Seu Nome *</label>
                    <input type="text" id="cliente-nome" placeholder="Seu nome">
                </div>
                <div class="input-group">
                    <label>WhatsApp *</label>
                    <input type="tel" id="cliente-zap" placeholder="Seu número">
                </div>

                <h4 style="margin: 15px 0 10px; color: #555;">Como deseja pagar?</h4>
                
                <button id="btn-pagar-link" class="btn-cartao" onclick="pagarComCartao()">
                    <i class="fas fa-credit-card"></i> Pagar com Cartão
                </button>

                <p style="text-align:center; font-size:0.8rem; color:#888; margin:5px 0;">- OU -</p>
                
                <button class="btn-comprar" onclick="finalizarPedidoZap()">
                    <i class="fab fa-whatsapp"></i> Pedir no WhatsApp
                </button>
            </div>
        </div>
    </div>

    <div id="modal-sucesso">
        <div class="sucesso-card">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #2E7D32; margin-bottom: 20px;"></i>
            <h3>Pedido Iniciado!</h3>
            <p>Seu código de pedido é:</p>
            <div class="pedido-id" id="sucesso-id">#1234</div>
            <p style="margin-top:20px; font-size:0.9rem; color:#666">
                Se você já pagou, envie este código no WhatsApp para confirmarmos.
            </p>
            <button class="btn-comprar" onclick="fecharSucesso()" style="margin-top:20px">
                <i class="fab fa-whatsapp"></i> Enviar Comprovante
            </button>
        </div>
    </div>

    <script src="script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBrRLiEFF8dfWHVxhK3popdYgEDQLiKzCM", authDomain: "gabriele-personaliza.firebaseapp.com", projectId: "gabriele-personaliza", storageBucket: "gabriele-personaliza.firebasestorage.app", messagingSenderId: "403724311605", appId: "1:403724311605:web:850e1bb14459a3ec60e57c", measurementId: "G-T24GYM57CT" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let produtoAtual = {};

        // 1. CARREGAR LOJA
        window.carregarLoja = async (filtro = 'todos') => {
            const container = document.getElementById('container-produtos');
            // Reset filtros
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            // (Lógica simples de filtro visual seria melhor, mas mantendo a sua estrutura:)
            
            try {
                const q = await getDocs(collection(db, "produtos"));
                container.innerHTML = '';
                q.forEach(doc => {
                    const p = doc.data();
                    if(filtro !== 'todos' && p.categoria !== filtro) return;
                    
                    // Lógica Fotos
                    let listaImagens = (p.fotos && p.fotos.length > 0) ? p.fotos : (p.foto ? [p.foto] : []);
                    let imagensHtml = '';
                    if(listaImagens.length > 0) {
                        listaImagens.forEach((img, i) => imagensHtml += `<img src="${img}" class="carousel-img ${i===0?'active':''}" style="${p.ativo?'':'filter:grayscale(1);opacity:0.6'}">`);
                    } else {
                        imagensHtml = `<div class="carousel-img active" style="background:#E1BEE7;height:100%"></div>`;
                    }

                    // Botão
                    let btnHtml = p.ativo ? `<button class="btn-sm" style="width:100%;border:none;background:#B39DDB;color:white;padding:8px;border-radius:5px;cursor:pointer;margin-top:5px;">Ver Detalhes</button>` : `<span style="color:red;font-size:0.8rem">Esgotado</span>`;
                    
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-img-wrapper carousel-container">
                            ${!p.ativo ? '<div class="badge-bestseller" style="background:red">Esgotado</div>' : ''}
                            ${imagensHtml}
                        </div>
                        <div class="product-info"><span class="category-tag">${p.categoria}</span><h3>${p.nome}</h3><div class="product-price">R$ ${p.preco}</div>${btnHtml}</div>`;
                    
                    if(p.ativo) card.onclick = () => abrirModal(p);
                    container.appendChild(card);
                });
                iniciarCarrossel();
            } catch(e) { console.error(e); }
        }

        function iniciarCarrossel() {
            if(window.carrosselInterval) clearInterval(window.carrosselInterval);
            window.carrosselInterval = setInterval(() => {
                document.querySelectorAll('.carousel-container').forEach(c => {
                    const imgs = c.querySelectorAll('.carousel-img');
                    if(imgs.length <= 1) return;
                    let active = 0; imgs.forEach((img,i) => { if(img.classList.contains('active')) active=i; img.classList.remove('active'); });
                    imgs[(active+1)%imgs.length].classList.add('active');
                });
            }, 3000);
        }

        window.abrirModal = (p) => {
            produtoAtual = p;
            document.getElementById('modal-produto').style.display = 'flex';
            document.getElementById('modal-titulo').innerText = p.nome;
            document.getElementById('modal-preco').innerText = `R$ ${p.preco}`;
            document.getElementById('modal-descricao').innerText = p.descricao || "";
            
            const imgC = document.getElementById('modal-imagens'); imgC.innerHTML = '';
            (p.fotos || [p.foto]).forEach(f => { if(f) imgC.innerHTML += `<img src="${f}" class="modal-img">`; });

            const btnLink = document.getElementById('btn-pagar-link');
            if(p.link_pagamento && p.link_pagamento.length > 5) {
                btnLink.style.display = 'flex';
                // Não colocamos o href aqui, pois vamos interceptar o clique
            } else {
                btnLink.style.display = 'none';
            }
        }

        window.fecharModal = () => document.getElementById('modal-produto').style.display = 'none';

        // --- NOVA LÓGICA DE PAGAMENTO COM CHECK-IN ---
        
        async function registrarPedido(origem) {
            const nome = document.getElementById('cliente-nome').value;
            const zap = document.getElementById('cliente-zap').value;
            
            if(!nome || !zap) {
                alert("Por favor, preencha seu Nome e WhatsApp para continuarmos!");
                return null;
            }

            // Gera um código curto aleatório (Ex: #A1B2)
            const idCurto = '#' + Math.random().toString(36).substr(2, 4).toUpperCase();
            
            try {
                // Salva no banco "Aguardando Pagamento"
                await addDoc(collection(db, "pedidos"), { 
                    id_visual: idCurto,
                    cliente: nome, 
                    whatsapp: zap, 
                    produto: produtoAtual.nome, 
                    total: produtoAtual.preco, 
                    data: new Date().toISOString(), 
                    status: origem === 'Cartão' ? 'Aguardando Pagamento' : 'Pendente',
                    origem: origem 
                });
                return idCurto;
            } catch(e) {
                alert("Erro ao registrar: " + e.message);
                return null;
            }
        }

        window.pagarComCartao = async () => {
            const btn = document.getElementById('btn-pagar-link');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = "Gerando Pedido...";

            // 1. Registra no sistema antes de deixar sair
            const idPedido = await registrarPedido('Cartão');
            
            if(idPedido) {
                // 2. Abre o Mercado Pago em outra aba
                window.open(produtoAtual.link_pagamento, '_blank');
                
                // 3. Mostra tela de sucesso com o código
                fecharModal();
                document.getElementById('sucesso-id').innerText = idPedido;
                document.getElementById('modal-sucesso').style.display = 'flex';
            }
            btn.innerHTML = textoOriginal;
        }

        window.finalizarPedidoZap = async () => {
            const idPedido = await registrarPedido('WhatsApp');
            if(idPedido) {
                const nome = document.getElementById('cliente-nome').value;
                const msg = `Olá! Sou *${nome}*.\nFiz o pedido *${idPedido}* (${produtoAtual.nome} - R$ ${produtoAtual.preco}).\nAguardo confirmação!`;
                window.open(`https://wa.me/559292770409?text=${encodeURIComponent(msg)}`, '_blank');
                fecharModal();
            }
        }

        window.fecharSucesso = () => {
            // Manda msg com o código para o Zap
            const id = document.getElementById('sucesso-id').innerText;
            const nome = document.getElementById('cliente-nome').value;
            const msg = `Olá! Sou *${nome}*.\nAcabei de pagar o pedido *${id}* no cartão/pix.\nAqui está o comprovante:`;
            window.open(`https://wa.me/559292770409?text=${encodeURIComponent(msg)}`, '_blank');
            document.getElementById('modal-sucesso').style.display = 'none';
        }

        document.getElementById('btn-secreto').addEventListener('click', () => { if(prompt("Senha:") === 'gabi123') { sessionStorage.setItem('admin_logado','sim'); window.location.href='admin.html'; } });
        carregarLoja();
    </script>
</body>
</html>